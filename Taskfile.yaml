version: '3'

tasks:

  # This command may require to be run with "sudo". 
  # User should have $GOPATH/bin dir in $PATH.
  #
  # Additional resources:
  # - https://go.dev/doc/install
  # - https://protobuf.dev/getting-started/gotutorial/
  # - https://protobuf.dev/installation/
  # - https://go.dev/doc/tutorial/govulncheck
  tools:
    desc: "Downloads all required tools required to develop project"
    cmds:
      - go install golang.org/x/vuln/cmd/govulncheck@latest
      - go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
      - apt install -y protobuf-compiler

      # depending whether command was run with or without "sudo", it may
      # influence whether this step succeds. In case of error, please manually
      # check if tools are installed correctly (with or without "sudo" command)
      - protoc --version && govulncheck --version && protoc-gen-go --version

  cleanup:
    desc: "Cleans up the socket"
    cmds:
      - rm -rf /tmp/cryptobroker.sock

  run:
    desc: "Runs the server locally"
    deps: [build-go]
    cmds:
      - defer: {task: cleanup}
      - CRYPTO_BROKER_PROFILES_DIR=$(pwd)/profiles ./bin/cryptobroker-server

  # see: "go tool dist list" for supported architectures in case you need to add another
  build-arch:
    desc: Build Go binary for multiple platforms
    cmds:
      - GOOS=windows GOARCH=386 go build -o bin/cryptobroker-server-windows-x86.exe cmd/server/server.go
      - GOOS=linux GOARCH=arm64 go build -o bin/cryptobroker-server-linux-arm64 cmd/server/server.go
      - GOOS=linux GOARCH=amd64 go build -o bin/cryptobroker-server-linux-amd64 cmd/server/server.go
    sources:
      - cmd/server/server.go
      - internal/**/*.go
      - go.mod
      - go.sum
    generates:
      - bin/cryptobroker-server-windows-x86.exe
      - bin/cryptobroker-server-linux-arm64
      - bin/cryptobroker-server-linux-amd64

  build-go:
    desc: "Builds the Go server binary"
    cmds:
      - go build -o bin/cryptobroker-server cmd/server/server.go
    sources:
      - cmd/server/server.go
      - internal/**/*.go
      - go.mod
      - go.sum
    generates:
      - bin/cryptobroker-server

  build:
    desc: "Builds the Docker image"
    vars:
      TAG: '{{.TAG| default "latest"}}'
    dotenv: ['.env']
    cmds:
      - docker buildx build --build-arg="CRYPTO_BROKER_PROFILES_DIR"=profiles -t server_app:{{.TAG}} .

  proto:
    desc: "Generates Go stubs from proto files"
    cmds:
      - git submodule update --init --recursive
      - protoc --go_out=. --go-grpc_out=. protobuf/messages.proto

  ci:
    desc: "Runs local continuous integration checks on source code"
    dotenv: ['.env']
    cmds:
      - go fmt ./...
      - go vet ./...
      - CRYPTO_BROKER_PROFILES_DIR=$(pwd)/profiles go test ./... -skip E2E -cover
      - CRYPTO_BROKER_PROFILES_DIR=$(pwd)/profiles go test ./... -run E2E -cover
      - govulncheck ./...

  example-profile:
    desc: "Command generates example Profiles.yaml file in profiles/ dir."
    cmds:
      - touch profiles/Profiles.yaml
      - |
        cat <<EOF > profiles/Profiles.yaml
        ---
        - Name: Default
          Settings:
            CryptoLibrary: native
          API:
            HashData:
              HashAlg: sha3-512
            SignCertificate:
              SignAlg: ecdsa
              HashAlg: sha-512
              Validity:
                ValidNotBeforeOffset: -1h
                ValidNotAfterOffset: 8760h
              KeyConstraints:
                Subject:
                  RSA:
                    MinKeySize: 2048
                    MaxKeySize: 4096
                  ECDSA:
                    MinKeySize: 256
                    MaxKeySize: 521
                Issuer:
                  RSA:
                    MinKeySize: 3072
                    MaxKeySize: 8192
                  ECDSA:
                    MinKeySize: 384
                    MaxKeySize: 521
              KeyUsage:         [digitalSignature, keyEncipherment]
              ExtendedKeyUsage: [clientAuth]
              BasicConstraints:
                CA: false
        EOF
    silent: true
